/*! jquery.highlightText 2016-11-16 */
!function(a,b){if("function"==typeof define&&define.amd)define(["jquery"],function(a){return b(a)});else if("undefined"!=typeof exports){var c=require("jquery");module.exports=b(c)}else b(a.$)}(this,function(a){"use strict";a.fn.Highlighter=function(b){var c=this;return this.keepEvidencesHidden=!1,this._highlightMap={},this._highlightDocMap={},this.addToDOM={},this.config=b,a(window).resize(function(){c.reRender()}),this.reset=function(){this._highlightMap={},this._highlightDocMap={},this.reRender()},this._getParent=function(a){return"#"+a.documentId+" "+this.config.document},this.addEvidence=function(b,c){var d=this,e=this._getParent(b),f=a(e),g=f.parent(),h=g.find(".evidence_list");this._replaceEvidence(b),this._highlightDocMap[b.documentId]||(this._highlightDocMap[b.documentId]={},this.addToDOM[b.documentId]=!1),this._highlightDocMap[b.documentId][this._getHighlightMapIndex(b)]=b,c&&0==h.length&&(this.addToDOM[b.documentId]=!0,g.append(this._createEvidenceList(f)),h=g.find(".evidence_list")),this._highlightMap[d._getHighlightMapIndex(b)]=b,"selection_evidence"==b.id&&(this.addToDOM[b.documentId]=!0,0===h.length&&(h=this._createEvidenceList(f),g.append(h))),(c||this.addToDOM[b.documentId])&&d.addEvidenceToDiv(b,e,f,h)},this.addEvidenceToDiv=function(b,d,e,f){d=d||this._getParent(b),e=e||a(d);var g,h,i,j,k=b.evidence;if("undefined"!=typeof b.id&&f.find("#"+b.id).length>0)return f.find("#"+b.id+" span").addClass(b.class),!0;var l;if("object"==typeof this&&!this.keepEvidencesHidden||"selection_evidence"==b.id){l={},h=g=this._unescape(e.html()),i=k.trim().split(" "),j=i[0],j.length<3&&i.length>1&&(j=j+" "+k.trim().split(" ")[1]||"");var m=this._htmlBegin(g,b.begin,j),n=g.substring(m,g.length-1).indexOf(k.trim()),o="",p=1;do if(p++,j+=o,o=g.substring(m+n+j.length,m+n+j.length+1),p>10)break;while(" "!==o&&"<"!==o);g=g.substring(0,m+n)+'<span class="_tmp_'+b.name+' _tmp_span">'+j+"</span>"+g.substring(m+n+j.length),e.html(g);var q=a("._tmp_"+b.name+"._tmp_span");if(q.css("fontFamily",e.css("fontFamily")).css("fontSize",e.css("fontSize")).css("line-height",e.css("line-height")).css("letter-spacing",e.css("letter-spacing")).css("word-spacing",e.css("word-spacing")),l=q.position(),"undefined"==typeof l)return;e.html(h);var r;"selection_evidence"!=b.id&&a.each(f.find("code"),function(c,d){if(b.begin<=a(d).find("span").data("begin"))return r=d,!1});var s=a("<code></code>").attr("id",b.id).attr("style","margin-left:0px; margin-top:"+l.top+"px;"),t=a("<span></span>").addClass("_code_string "+b.name+" "+b.class).data("begin",b.begin).data("documentId",b.documentId).css("fontFamily",e.css("fontFamily")).css("fontSize",e.css("fontSize")).css("line-height",e.css("line-height")).css("letter-spacing",e.css("letter-spacing")).css("word-spacing",e.css("word-spacing")).html(k).css("marginLeft",l.left-parseInt(e.css("paddingLeft"))-this._calculateLeftPaddingMarginAllParent(d)+"px");s.append(t),r?b.el=f.find(r).before(s):b.el=f.append(s),f.on("click","#"+b.id+" span",function(d){"selection_evidence"==a(d.target).parent().attr("id")&&"function"==typeof c.config.onSelectionClick?c.config.onSelectionClick(b,d):"function"==typeof b.click&&b.click(b,d)})}},this.addEvidencesToDOM=function(b,c){if(this.addToDOM[b]=!0,this._highlightDocMap[b]){var d,e,f=a("#"+b),g=this;if(0==f.find(".evidence_list").length){var h=this._createEvidenceList(e);if(a.each(this._highlightDocMap[b],function(b,c){d=d||g._getParent(c),e=e||a(d),g.addEvidenceToDiv(c,d,e,h)}),this._positionEvidenceList(h,e),!e||e.length<=0)return;f.append(h)}}"function"==typeof c&&c()},this.addAllDocEvidenceToDom=function(){var b=this;a.each(this._highlightDocMap,function(a,c){b.addEvidencesToDOM(a)})},this.removeEvidence=function(b,c){var d={};d.id=b,d.source=c;this._deleteEvidence(d);var e=0,f=a("<div>");a.each(this._highlightMap,function(a,c){c.id==b&&(e++,f.addClass(c.class),f.addClass(c.name))}),0==e?(a("#"+b).remove(),a(".evidence_list").off("click","#"+d.id+" span")):(a("#"+b+" span").attr("class",f.attr("class")),a("#"+b+" span").addClass("_code_string"))},this.findEvidence=function(a,b){a.id||"",a.source||"";key=this._getHighlightMapIndex(a);var c=this._highlightMap[key];"undefined"!=typeof c&&b(c,key)},this._getHighlightMapIndex=function(a){return a.id+"_"+a.source},this._deleteEvidence=function(a){if("undefined"==typeof a.documentId&&this._highlightMap[this._getHighlightMapIndex(a)]){if(a=this._highlightMap[this._getHighlightMapIndex(a)],"undefined"!=typeof this._highlightDocMap[a.documentId]){var b=this._highlightDocMap[a.documentId].selection_evidence_selection;b&&b.evidence&&b&&b.begin==a.begin&&b.documentId==a.documentId&&b.evidence.length==a.evidence.length&&(delete this._highlightDocMap[a.documentId].selectin_evidence_selection,delete this._highlightMap.selectin_evidence_selection)}delete this._highlightMap[this._getHighlightMapIndex(a)],"undefined"!=typeof this._highlightDocMap[a.documentId]&&delete this._highlightDocMap[a.documentId][this._getHighlightMapIndex(a)]}},this._replaceEvidence=function(b){if("undefined"==typeof b.documentId&&this._highlightMap[this._getHighlightMapIndex(b)]){if(b=this._highlightMap[this._getHighlightMapIndex(b)],"undefined"!=typeof this._highlightDocMap[b.documentId]){var c=this._highlightDocMap[b.documentId].selection_evidence_selection;c&&c.begin==b.begin&&c.documentId==b.documentId&&c.evidence.length==b.evidence.length&&(delete this._highlightDocMap[b.documentId].selectin_evidence_selection,delete this._highlightMap.selectin_evidence_selection)}delete this._highlightMap[this._getHighlightMapIndex(b)],"undefined"!=typeof this._highlightDocMap[b.documentId]&&delete this._highlightDocMap[b.documentId][this._getHighlightMapIndex(b)],a("#"+b.id).attr("class",b.class)}},this._createEvidenceList=function(b){var c=a('<div class="evidence_list"></div>');return b&&(c=this._positionEvidenceList(c,b)),c},this._positionEvidenceList=function(a,b){return a.attr("style","position: absolute; bottom: 0px; height: 100%; width:"+(parseInt(b.innerWidth())-(parseInt(b.css("paddingLeft"))+parseInt(b.css("paddingRight"))))+"px; margin-left:"+b.css("paddingLeft")+"; margin-right:"+b.css("paddingRight")+";")},this._unescape=function(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;>/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'")},this.removeEvidenceFromDocument=function(b){a("#"+b).find(".evidence_list").remove(),c.addToDOM[b]=!1},this._calculateLeftPaddingMarginAllParent=function(b){var c,d=0;return a(b).parents().each(function(b,e){var f=a(e);return f.parent().get(0)==document||"relative"===f.parent().css("position")?(d+=parseFloat(f.css("paddingLeft"))+parseFloat(f.css("border-left-width")),c&&(d+=parseFloat(c.offset().left)),!1):(d+=parseFloat(f.css("paddingLeft"))+parseFloat(f.css("border-left-width")),void(c=f))}),d},this._bindEvents=function(){a(this.config.document).on("mousedown",this._setNonePointerEvent),a(this.config.document).on("mouseup",this._setAllPointerEvent)},this._setNonePointerEvent=function(){a(this).parent().find(".evidence_list").find("code span").css("pointerEvents","none")},this._setAllPointerEvent=function(){a(this).parent().find(".evidence_list").find("code span").css("pointerEvents","all")},this._unbindEvents=function(){a(this.config.document).off("mousedown",this._setNonePointerEvent),a(this.config.document).off("mouseup",this._setAllPointerEvent)},this._htmlCount=function(a){var b=document.createElement("DIV");b.innerHTML=a;var c=b.textContent||b.innerText||"";return a.length-c.length},this._htmlBegin=function(a,b,c){var d=a.substring(0,b)||"",e=this._htmlCount(d);return d=a.substring(0,b+e),b+e+a.substring(b+e,b+e+150).indexOf(c)},this.getHightlightCount=function(a){return _.Object.keys(this._highlightDocMap[a]).length},this.reRender=function(){a(".evidence_list").remove(),c._unbindEvents(),this.keepEvidencesHidden||(a.each(this.addToDOM,function(a,b){b===!0&&c.addEvidencesToDOM(a)}),c._bindEvents())},this.removeAllEvidences=function(){a(".evidence_list").remove(),c._unbindEvents()},this.showEvidences=function(){this.keepEvidencesHidden=!1,this.reRender()},this.hideEvidences=function(){this.keepEvidencesHidden=!0,this.removeAllEvidences()},this.getNextSource=function(b,d){var e=[],f=this;return a.each(c._highlightMap,function(a,c){c.evidence==b&&c.id===d&&e.push(c)}),d||(this.lastSource=d),this.lastSource&&this.lastSource.evidence==b&&this.lastSource.id===d?a.each(e,function(a,b){return f.lastSource.id===b.id&&a<e.length-1?f.lastSource.source===b.source?(f.lastSource=e[a+1],!1):void 0:(f.lastSource=e[0],!1)}):this.lastSource=e[0],this.lastSource},a(this).on("mouseup",function(d){var e=c.getSelectionCharOffsetsWithin(a(d.target).closest(c.config.document)[0]);a(d.target).hasClass("selection")||c.removeEvidence("selection_evidence","selection");var f=a(d.target).closest(c.config.document).parent().attr("id")||"";c.config.highlightSelection&&"undefined"!=typeof e&&e.string&&e.string.length>0&&c.addEvidence({evidence:e.string,begin:e.start,end:e.end,name:"selection",id:"selection_evidence",documentId:f,class:"yellow",source:"selection"}),b.mouseup&&b.mouseup(e,d)}),a(this).on("mousedown",function(a){b.mousedown&&b.mousedown(a)}),this._rTrim=function(a){return a.replace(/\s+$/,"")},this.getSelected=function(){var a="";return document.selection?a=document.selection.createRange():document.getSelection?a=document.getSelection():window.find("").getSelection&&(a=window.getSelection()),a},this.getSelectionCharOffsetsWithin=function(b){var c,d,e,f,g=0,h=0,i=0;if(a.isArray(b)&&b.length>0&&(b=b[0]),""!==this.getSelected()){"undefined"!=typeof window.getSelection?(c=this._rTrim(window.getSelection().toString()),i=c.indexOf(c.trim().split(" ")[0]),c=c.trim(),c&&c.length>0&&(e=window.getSelection().getRangeAt(0),f=e.cloneRange(),f.selectNodeContents(b),f.setEnd(e.startContainer,e.startOffset),g=f.toString().length,h=g+e.toString().length,window.getSelection().removeAllRanges())):"undefined"!=typeof document.selection&&"Control"!=(d=document.selection).type&&(c=this._rTrim(d.createRange().text),i=c.indexOf(c.trim().split(" ")[0]),c=c.trim(),c&&c.length>0&&(e=d.createRange(),f=document.body.createTextRange(),f.moveToElementText(b[0]),f.setEndPoint("EndToStart",e),g=f.text.length,h=g+e.text.length,document.selection.empty()));var j,k,l,m,n,o;if(e&&e.commonAncestorContainer.data){j=e.startOffset,k=e.endOffset,m=e.commonAncestorContainer.data.substring(j,j+1),l=e.commonAncestorContainer.data.substring(j-1,j),n=e.commonAncestorContainer.data.substring(k-1,k),o=e.commonAncestorContainer.data.substring(k,k+1);var p=0,q=0;if(" "!=m)for(;" "!=l&&null!=l.match("[a-zA-Z0-9]");)g-=1,p+=1,l=e.commonAncestorContainer.data.substring(e.startOffset-(p-1),e.startOffset-p),c=l+c;if(" "!=n)for(;" "!=o&&null!=o.match("[a-zA-Z0-9]");)h+=1,q+=1,c+=o,o=e.commonAncestorContainer.data.substring(e.endOffset+q,e.endOffset+(q+1))}return!(!(c&&c.length>0)||this.is_html(c)||null!=l.match("[a-zA-Z0-9]")&&" "!=m)&&{string:c,start:g+i,end:h}}return!1},this.is_html=function(a){return/\n/.test(a)||/\t/.test(a)},this.preHTMLCount=function(b){var c=b.cloneContents(),d=0;return"undefined"==typeof c.children&&(c.children=c.childNodes),a.each(c.children,function(b,c){d+="undefined"!=typeof a(c)[0].outerHTML?parseInt(a(c)[0].outerHTML.length):0}),d},this.generateRandomID=function(){return Date.now()},this._bindEvents(),this}});